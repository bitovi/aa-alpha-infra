name: WAF Rule Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform (create or destroy)"
        required: true
        default: create
        type: choice
        options:
          - create
          - destroy
      enable_block_rule:
        description: "BLOCK NON-ALLOWED IPs"
        required: false
        default: true
        type: boolean
      override_environment_default_block_setting:
        description: "CLICK THIS IF YOU KNOW WHAT YOU ARE DOING (overrides default block rule behavior based on environment)"
        required: false
        default: false
        type: boolean
      environment:
        description: 'The environment to deploy to'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: development

### WARNING ###
# This workflow manages WAF rules via Terraform.
# Changing WAF rules can have significant security implications.
# Ensure you understand the impact of enabling or disabling block rules,
# especially in production environments.
#
#
# As a default, production environments have BLOCKING DISABLED to prevent accidental lockouts.
#
# The override_environment_default_block_setting input allows you to explicitly set the block rule behavior,
# but should be used with caution.

jobs:
  WAF-Rules:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
    env:
      AWS_REGION: ${{ vars.AWS_DEFAULT_REGION || 'us-east-1' }}
      TF_BUCKET: aa-wafacl-tf-state-${{ github.event.inputs.environment }}
      TF_STATE_KEY: wafacl-${{ github.event.inputs.environment }}.tfstate
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      TF_DIR: terraform/waf
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_DEFAULT_REGION || 'us-east-1' }}

      - name: Create S3 bucket for Terraform state (if needed)
        run: |
          if ! aws s3api head-bucket --bucket "$TF_BUCKET" 2>/dev/null; then
            echo "Creating S3 bucket $TF_BUCKET for Terraform state..."
            aws s3api create-bucket --bucket "$TF_BUCKET" --region "$AWS_REGION" $(if [ "$AWS_REGION" != "us-east-1" ]; then echo "--create-bucket-configuration LocationConstraint=$AWS_REGION"; fi)
          else
            echo "S3 bucket $TF_BUCKET already exists."
          fi

      - name: Setup Terraform backend and provider config
        working-directory: ${{ env.TF_DIR}}
        run: |
          cat > backend.tf <<EOF
          terraform {
            backend "s3" {
              bucket = "$TF_BUCKET"
              key    = "$TF_STATE_KEY"
              region = "$AWS_REGION"
            }
          }
          EOF

          cat > provider.tf <<EOF
          provider "aws" {
            region = "$AWS_REGION"
          }
          EOF

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init

      - name: Terraform Apply or Destroy
        working-directory: ${{ env.TF_DIR }}
        run: |
          # Determine block rule setting based on environment and override
          if [ "${{ github.event.inputs.override_environment_default_block_setting }}" = "true" ]; then
            # Use the explicit input value
            BLOCK_RULE="${{ github.event.inputs.enable_block_rule }}"
          else
            # Use environment-based defaults
            if [ "${{ env.ENVIRONMENT }}" = "production" ]; then
              BLOCK_RULE="false"
            else
              BLOCK_RULE="true"
            fi
          fi
          
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "Override enabled: ${{ github.event.inputs.override_environment_default_block_setting }}"
          echo "Block rule setting: $BLOCK_RULE"
          
          if [ "${{ github.event.inputs.action }}" = "create" ]; then
            terraform apply -auto-approve \
              -var environment=${{ env.ENVIRONMENT }} \
              -var aws_region=${{ env.AWS_REGION }} \
              -var enable_block_rule=$BLOCK_RULE
          else
            terraform destroy -auto-approve \
              -var environment=${{ env.ENVIRONMENT }} \
              -var aws_region=${{ env.AWS_REGION }} \
              -var enable_block_rule=$BLOCK_RULE
          fi
